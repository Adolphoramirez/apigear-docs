"use strict";(self.webpackChunkapigear=self.webpackChunkapigear||[]).push([[4498],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,l=e.originalType,s=e.parentName,c=r(e,["components","mdxType","originalType","parentName"]),u=p(n),d=o,h=u["".concat(s,".").concat(d)]||u[d]||m[d]||l;return n?a.createElement(h,i(i({ref:t},c),{},{components:n})):a.createElement(h,i({ref:t},c))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var l=n.length,i=new Array(l);i[0]=d;var r={};for(var s in t)hasOwnProperty.call(t,s)&&(r[s]=t[s]);r.originalType=e,r[u]="string"==typeof e?e:o,i[1]=r;for(var p=2;p<l;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},7523:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>l,metadata:()=>r,toc:()=>p});var a=n(7462),o=(n(7294),n(3905));const l={sidebar_position:3},i="Network Protocols",r={unversionedId:"advanced/simulation/protocols",id:"advanced/simulation/protocols",title:"Network Protocols",description:"The simulation framework allows client to simulate interfaces using a simulation server. A client receives simulated responses or behavior based on a provided scenario document.",source:"@site/docs/advanced/simulation/protocols.md",sourceDirName:"advanced/simulation",slug:"/advanced/simulation/protocols",permalink:"/docs/advanced/simulation/protocols",draft:!1,editUrl:"https://github.com/apigear-io/apigear-docs/edit/main/docs/advanced/simulation/protocols.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"docsSidebar",previous:{title:"Scenario Documents",permalink:"/docs/advanced/simulation/scenario"},next:{title:"Simulation with Studio",permalink:"/docs/advanced/simulation/studio"}},s={},p=[{value:"Example",id:"example",level:2},{value:"HTTP Endpoint",id:"http-endpoint",level:3},{value:"JSON RPC over WebSockets",id:"json-rpc-over-websockets",level:2},{value:"Protocol Flow",id:"protocol-flow",level:3},{value:"Simulating Operations",id:"simulating-operations",level:3},{value:"Interface State",id:"interface-state",level:2},{value:"Simulating Signals",id:"simulating-signals",level:3}],c={toc:p};function u(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"network-protocols"},"Network Protocols"),(0,o.kt)("p",null,"The simulation framework allows client to simulate interfaces using a simulation server. A client receives simulated responses or behavior based on a provided scenario document."),(0,o.kt)("p",null,"The simulation server can be called via HTTP or websocket using JSON-RPC. The different protocols and behavior will be explained below."),(0,o.kt)("h2",{id:"example"},"Example"),(0,o.kt)("p",null,"We will use always our counter example which looks like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'schema: apigear.module/1.0\nname: demo\nversion: "1.0"\n\ninterfaces:\n  - name: Counter\n    properties:\n      - name: count\n        type: int\n    operations:\n      - name: increment\n        params:\n          - name: step\n            type: int\n      - name: decrement\n        params:\n          - name: step\n            type: int\n  - name: Echo\n    operations:\n      - name: say\n        params:\n          - name: message\n            type: string\n        return:\n          - type: string\n')),(0,o.kt)("p",null,"We can identify an operation using an URI like this ",(0,o.kt)("inlineCode",{parentName:"p"},"demo.Counter/increment")," and a service like this ",(0,o.kt)("inlineCode",{parentName:"p"},"demo.Counter"),"."),(0,o.kt)("p",null,"As a convention, calling the service should always give back the current state, which is the sum of properties. Calling an operation should always return a valid value defined by the ",(0,o.kt)("inlineCode",{parentName:"p"},"return")," type."),(0,o.kt)("h3",{id:"http-endpoint"},"HTTP Endpoint"),(0,o.kt)("p",null,"The HTTP endpoint is the simples to use but is also limited in functionality. It only support direct responses on requests. Whereas the websockets protocols allow also playbook based active simulations."),(0,o.kt)("p",null,"You can start the simulation server using a pre-defined, manually entered or auto-deducted port. If you use the local server then the endpoint will be available at ",(0,o.kt)("inlineCode",{parentName:"p"},"http://localhost:${PORT}/simulation/"),". The call must be a post request and the payload must be a JSON document in the form of:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "symbol": "${module}.${object}/${operation}",\n  "data": "${params}"\n}\n')),(0,o.kt)("p",null,"Where the payload is based on the ObjectAPI endpoint notation. ",(0,o.kt)("inlineCode",{parentName:"p"},"${module}.${$interface}/${operation}"),"."),(0,o.kt)("p",null,"Using the ",(0,o.kt)("a",{parentName:"p",href:"https://httpie.io/"},"http")," tool we can write"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'http :3000 symbol=demo.Counter/increment data="{ step: 5 }"\n')),(0,o.kt)("p",null,"It is also valid to call the endpoint without parameters, in this case some actions relying on the step parameter might fail if defined."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"http :3000 symbol=demo.Counter/increment\n")),(0,o.kt)("p",null,"To get the latest state you can call the object directly"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"http :3000 symbol=demo.Counter\n")),(0,o.kt)("p",null,"The response will be the state"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "count": 25\n}\n')),(0,o.kt)("p",null,"of the interface."),(0,o.kt)("h2",{id:"json-rpc-over-websockets"},"JSON RPC over WebSockets"),(0,o.kt)("p",null,"The second supported simulation protocol is the ",(0,o.kt)("a",{parentName:"p",href:"https://www.jsonrpc.org/specification"},"JSON-RPC")," over websocket protocol. The simulation is fully supported and supports also active simulations."),(0,o.kt)("h3",{id:"protocol-flow"},"Protocol Flow"),(0,o.kt)("p",null,"The communication flow is typically initiated by the client by requesting the state of an object using the ",(0,o.kt)("inlineCode",{parentName:"p"},"simu.state")," call."),(0,o.kt)("p",null,"The client can call operations on the simulation. A call can trigger other signals from the simulation as part of the scenario ",(0,o.kt)("inlineCode",{parentName:"p"},"actions"),"."),(0,o.kt)("p",null,"An simulation which contains a playbook can actively send signals to the client without an external trigger."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"Client                  Simulation          Description\n\nsimu.call ->                                call an operation\nsimu.state ->                           return property changes\n                        <- simu.state       notify property changes\n                        <- simu.signal      emit a signal\n")),(0,o.kt)("h3",{id:"simulating-operations"},"Simulating Operations"),(0,o.kt)("p",null,"To call an operation endpoint the format is"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "jsonrpc": "2.0",\n  "id": 1,\n  "method": "simu.call",\n  "params": {\n    "symbol": "demo.Echo/say",\n    "data": {\n      "message": "hello"\n    }\n  }\n}\n')),(0,o.kt)("p",null,"The response will be either an error or the return value of the operation as a JSON-RPC result response."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "jsonrpc": "2.0",\n  "id": 1,\n  "result":\n    "hello"\n  },\n}\n')),(0,o.kt)("h2",{id:"interface-state"},"Interface State"),(0,o.kt)("p",null,"To get the state of a service you need to call the service itself using the ",(0,o.kt)("inlineCode",{parentName:"p"},"simu.state")," method."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "jsonrpc": "2.0",\n  "id": 1,\n  "method": "simu.state",\n  "params": {\n    "symbol": "demo.Counter"\n  }\n}\n')),(0,o.kt)("p",null,"The response will be current the state of the service."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "jsonrpc": "2.0",\n  "id": 1,\n  "result":\n    "count": 20\n  },\n}\n')),(0,o.kt)("h3",{id:"simulating-signals"},"Simulating Signals"),(0,o.kt)("p",null,"The server might also call the client to notify the client about server side events, e.g. state changes or signal invoked by an action."),(0,o.kt)("p",null,"The state changes are announced through sending a JSON-RPC notification back to the client. A notification in JSON-RPC looks like a call, but it does not have an ID parameter and no response is send back from the client."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "jsonrpc": "2.0",\n  "method": "simu.state",\n  "params": {\n    "symbol": "demo.Counter",\n    "data": {\n      "count": 10\n    }\n  }\n}\n')),(0,o.kt)("p",null,"The fields response are the changed fields in the state object and need to merged with the existing client side state. To get a full state you need to call the service."),(0,o.kt)("p",null,"The simulation will also send signals as noted in the ObjectAPI back to the client. For this a ",(0,o.kt)("inlineCode",{parentName:"p"},"simu.signal")," RPC message is used."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "jsonrpc": "2.0",\n  "method": "simu.signal",\n  "params": {\n    "symbol": "demo.Hello/shutdown",\n    "data": {\n      "timeout": 10\n    }\n  }\n}\n')))}u.isMDXComponent=!0}}]);